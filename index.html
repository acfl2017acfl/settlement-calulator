<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settlement Offer Calculator (3+1, 4+1, 6+1)</title>
  <style>
    :root{
      --bg:#071026; --panel:#0d1420; --muted:#98a6bf; --accent:#6b8cff; --glass: rgba(255,255,255,0.03);
      --success:#4dd0e1; --card-pad:12px; --font-base:15px
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#eaf2ff;background:linear-gradient(180deg,var(--bg) 0%, #0b1220 100%);font-size:var(--font-base)}
    .wrap{max-width:980px;margin:12px auto;padding:12px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--success));color:#07203a}
    h1{margin:0;font-size:16px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01));padding:var(--card-pad);border-radius:10px;border:1px solid var(--glass);box-shadow:0 8px 18px rgba(2,6,23,0.6)}

    /* Two-column layout that preserves desktop-like look on mobile by compressing right column */
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media (max-width:600px){
      /* On most phones, keep two-column but compress right column and reduce spacing */
      .grid{grid-template-columns:1fr 260px;gap:10px}
      .logo{width:36px;height:36px}
      :root{--card-pad:10px;--font-base:14px}
    }
    @media (max-width:420px){
      /* Very small phones — slightly smaller right column but still two-column */
      .grid{grid-template-columns:1fr 220px;gap:8px}
      :root{--card-pad:8px;--font-base:13px}
    }

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=number], input[type=date], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    button{padding:7px 10px;border-radius:8px;border:0;cursor:pointer;font-weight:700;background:var(--accent);color:#052033;font-size:14px}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:10px;font-size:13px}
    thead th{text-align:left;color:var(--muted);font-size:12px;padding-left:8px}
    td{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    .cell-amount{min-width:100px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
    .aside-list{display:flex;flex-direction:column;gap:10px}
    .offer-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .small{font-size:13px;color:var(--muted)}
    .schedule{margin-top:8px;font-size:13px;color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:13px}

    /* Ensure table never stacks into long vertical card blocks on mobile — keep compact rows */
    @media (max-width:420px){
      thead th{font-size:11px}
      td{padding:8px}
      .controls{gap:6px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">SO</div>
      <div>
        <h1>Settlement Offer Calculator</h1>
        <p class="lead">Principal + Interest Outstanding + future OD (per offer) → divide by (N+1). Installments always rounded UP to next ₹10.</p>
      </div>
    </header>

    <div class="grid">
      <!-- left: inputs + results table -->
      <div>
        <div class="card" aria-labelledby="inputs">
          <div id="inputs">
            <label>Principal Outstanding (₹)</label>
            <input id="principal" type="number" min="0" step="1" value="50000" inputmode="numeric" />

            <label style="margin-top:8px">Interest Outstanding (₹)</label>
            <input id="odToday" type="number" min="0" step="1" value="5000" inputmode="numeric" />

            <label style="margin-top:8px">Annual Interest Rate (%)</label>
            <input id="annualRate" type="number" min="0" step="0.01" value="27" inputmode="decimal" />

            <label style="margin-top:8px">First EMI Date (today)</label>
            <input id="firstDate" type="date" readonly />

            <div class="controls">
              <button id="recalc">Recalculate</button>
              <button id="reset" class="ghost">Reset</button>
              <button id="download" class="ghost">Download CSV</button>
              <button id="copy" class="ghost">Copy Results</button>
            </div>
          </div>

          <table id="results" aria-live="polite">
            <thead>
              <tr>
                <th>Outstanding (₹)</th>
                <th>Offer</th>
                <th>Installment (₹)</th>
                <th>Total Collection (₹)</th>
                <th>Discount (₹)</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <p class="muted" style="margin-top:8px">Formula preview: Total = Principal + InterestOutstanding + (Principal × monthlyRate × N). Installment = Total ÷ (N+1), rounded UP to next ₹10.</p>
        </div>
      </div>

      <!-- right: offer cards with schedule -->
      <aside>
        <div class="card aside-list">
          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">3+1</span></div>
              <div class="small" id="meta31"></div>
            </div>
            <div class="schedule" id="sched31"></div>
          </div>

          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">4+1</span></div>
              <div class="small" id="meta41"></div>
            </div>
            <div class="schedule" id="sched41"></div>
          </div>

          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">6+1</span></div>
              <div class="small" id="meta61"></div>
            </div>
            <div class="schedule" id="sched61"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer class="muted">Note: Installment is rounded <strong>up</strong> to the nearest ₹10. 'Discount' shown equals one installment (the "+1").</footer>
  </div>

  <script>
    // Utility: format INR without paise
    function formatINR(n){
      if (isNaN(n)) return '-';
      return new Intl.NumberFormat('en-IN', {style:'currency', currency:'INR', maximumFractionDigits:0}).format(Math.round(n));
    }

    // Keep date addMonths while preserving day where possible (fallback to end-of-month)
    function addMonthsKeepDay(date, months){
      const d = new Date(date.valueOf());
      const day = d.getDate();
      d.setMonth(d.getMonth() + months);
      // If month changed and day differs (eg Feb 30 -> Mar 2), adjust to last day of prev month
      if (d.getDate() !== day){
        // set to last day of previous month
        d.setDate(0);
      }
      return d;
    }

    // Round up to next 10
    function roundUp10(x){
      return Math.ceil(x / 10) * 10;
    }

    // Main calculation function for a given N (paid parts)
    function calcForN(principal, odToday, monthlyRate, N){
      // monthly interest on principal (simple)
      const monthlyInterestOnPrincipal = principal * monthlyRate;
      const futureOD = monthlyInterestOnPrincipal * N;
      const total = principal + odToday + futureOD;
      const rawInstallment = total / (N + 1);
      const installment = roundUp10(rawInstallment);
      const totalCollection = installment * N;
      const discount = installment;
      return {
        monthlyInterestOnPrincipal,
        futureOD,
        total,
        rawInstallment,
        installment,
        totalCollection,
        discount
      };
    }

    // Read / write elements
    const elPrincipal = document.getElementById('principal');
    const elOD = document.getElementById('odToday');
    const elRate = document.getElementById('annualRate');
    const elDate = document.getElementById('firstDate');
    const elRecalc = document.getElementById('recalc');
    const elReset = document.getElementById('reset');
    const elDownload = document.getElementById('download');
    const elCopy = document.getElementById('copy');
    const tbody = document.getElementById('tbody');

    const meta31 = document.getElementById('meta31');
    const meta41 = document.getElementById('meta41');
    const meta61 = document.getElementById('meta61');
    const sched31 = document.getElementById('sched31');
    const sched41 = document.getElementById('sched41');
    const sched61 = document.getElementById('sched61');

    // initialize date to today (always set it)
    (function setDefaultDateToday(){
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth() + 1).padStart(2,'0');
      const dd = String(t.getDate()).padStart(2,'0');
      elDate.value = `${yyyy}-${mm}-${dd}`;
    })();

    // Debounce
    function debounce(fn, ms){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), ms);
      };
    }

    // create schedule returning array of date strings for N paid parts starting at firstDate
    function buildSchedule(firstDateStr, N){
      const d0 = new Date(firstDateStr + 'T00:00:00'); // local midnight
      const arr = [];
      for(let i=0;i<N;i++){
        const d = addMonthsKeepDay(d0, i);
        arr.push(d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}));
      }
      return arr;
    }

    // Render all results
    function renderAll(){
      const principal = Number(elPrincipal.value) || 0;
      const odToday = Number(elOD.value) || 0;
      const annualRate = Number(elRate.value) || 0;
      const firstDate = elDate.value;
      const monthlyRate = annualRate / 12 / 100;

      const offers = [
        {label:'3+1', N:3},
        {label:'4+1', N:4},
        {label:'6+1', N:6}
      ];

      tbody.innerHTML = '';

      const rows = []; // for CSV & copy

      offers.forEach(off => {
        const N = off.N;
        const res = calcForN(principal, odToday, monthlyRate, N);
        // table row
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="cell-amount">${formatINR(principal + odToday + res.futureOD)}</td>
          <td>${off.label}</td>
          <td>${formatINR(res.installment)}</td>
          <td>${formatINR(res.totalCollection)}</td>
          <td>${formatINR(res.discount)}</td>
        `;
        tbody.appendChild(tr);

        // aside meta & schedule
        const metaTxt = `Future OD: ${formatINR(res.futureOD)} • Monthly interest on P: ${formatINR(res.monthlyInterestOnPrincipal)}`;
        const sched = buildSchedule(firstDate, N);

        if (off.N === 3){
          meta31.textContent = metaTxt;
          sched31.innerHTML = '<strong>Installment dates:</strong><br>' + sched.map(s=>`• ${s}`).join('<br>');
        } else if (off.N === 4){
          meta41.textContent = metaTxt;
          sched41.innerHTML = '<strong>Installment dates:</strong><br>' + sched.map(s=>`• ${s}`).join('<br>');
        } else if (off.N === 6){
          meta61.textContent = metaTxt;
          sched61.innerHTML = '<strong>Installment dates:</strong><br>' + sched.map(s=>`• ${s}`).join('<br>');
        }

        rows.push({
          Outstanding: Math.round(principal + odToday + res.futureOD),
          Offer: off.label,
          Installment: res.installment,
          TotalCollection: res.totalCollection,
          Discount: res.discount
        });
      });

      // Attach for download/copy
      currentRows = rows;
    }

    // CSV download helper
    function downloadCSV(rows){
      const header = ['Outstanding','Offer','Installment','TotalCollection','Discount'];
      const lines = [header.join(',')].concat(rows.map(r => [r.Outstanding, r.Offer, r.Installment, r.TotalCollection, r.Discount].join(',')));
      const csv = lines.join('
');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'settlement_offers.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Build text for copy
    function copyText(rows){
      let s = '';
      rows.forEach(r=>{
        s += `Outstanding: ${r.Outstanding}
Offer: ${r.Offer}
Installment: ${r.Installment}
TotalCollection: ${r.TotalCollection}
Discount: ${r.Discount}

`;
      });
      return s;
    }

    // Keep last rows for download/copy
    let currentRows = [];

    // Wire events
    const debouncedRender = debounce(renderAll, 120);

    elPrincipal.addEventListener('input', debouncedRender);
    elOD.addEventListener('input', debouncedRender);
    elRate.addEventListener('input', debouncedRender);
    elDate.addEventListener('change', debouncedRender);

    elRecalc.addEventListener('click', renderAll);
    elReset.addEventListener('click', ()=>{
      elPrincipal.value = 50000;
      elOD.value = 5000;
      elRate.value = 27;
      // reset date to today as well
      (function(){ const t = new Date(); const yyyy = t.getFullYear(); const mm = String(t.getMonth() + 1).padStart(2,'0'); const dd = String(t.getDate()).padStart(2,'0'); elDate.value = `${yyyy}-${mm}-${dd}`; })();
      renderAll();
    });

    elDownload.addEventListener('click', ()=> downloadCSV(currentRows));
    elCopy.addEventListener('click', async ()=>{
      const txt = copyText(currentRows);
      try{
        await navigator.clipboard.writeText(txt);
        alert('Results copied to clipboard');
      } catch(e){
        // fallback
        const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
        alert('Results copied to clipboard');
      }
    });

    // initial render
    renderAll();
  </script>
</body>
</html>
