<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settlement Offer Calculator (3+1, 4+1, 6+1) - Mobile</title>
  <style>
    :root{ --bg:#071026; --panel:#0b1220; --muted:#98a6bf; --accent:#e85222; --glass: rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#eaf2ff;background:linear-gradient(180deg,var(--bg) 0%, #0b1220 100%);}
    .wrap{max-width:420px;margin:10px auto;padding:12px}
    header{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .logo{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.04);padding:6px}
    .logo img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    h1{margin:0;font-size:16px}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.2}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid var(--glass);box-shadow:0 8px 28px rgba(2,6,23,0.6)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=number], input[type=date], select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;background:var(--accent);color:#fff}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
    thead th{text-align:left;color:var(--muted);font-size:13px;padding-left:10px}
    tbody tr { background: rgba(255,255,255,0.02); border-radius:8px; }
    td{padding:10px;border-radius:8px;font-size:14px}
    .cell-amount{font-weight:700}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
    .aside-list{display:flex;flex-direction:column;gap:10px}
    .offer-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .small{font-size:13px;color:var(--muted)}
    .schedule{margin-top:8px;font-size:13px;color:var(--muted)}
    footer{margin-top:12px;color:var(--muted);font-size:12px}
    @media (max-width:480px){ .controls{flex-direction:column} button{width:100%} table{width:100%; border-collapse:collapse; margin-top:12px} thead th{padding:8px 10px;font-size:13px} tbody tr{display:table-row; margin-bottom:8px} td{display:table-cell; padding:10px} tbody tr td { background: rgba(255,255,255,0.02); border-radius:8px; } .card{overflow-x:auto} }
    @media (max-width:360px){ h1{font-size:15px} .logo{width:40px;height:40px} }
    /* hide inputs (unchanged) */
    #labelDate, #firstDate, #labelRate, #annualRate { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden>
        <img src="ACFL Logo PNG WhiteBG.png" alt="ACFL Logo" />
      </div>
      <div>
        <h1>Settlement Offer Calculator</h1>
        <p class="lead">Principal + Interest Outstanding + Future Interest (per offer) → Divide by (N+1). Installments always rounded UP to next ₹10.</p>
      </div>
    </header>

    <div class="grid">
      <div>
        <div class="card" aria-labelledby="inputs">
          <div id="inputs">
            <label>Principal Outstanding (₹)</label>
            <input id="principal" type="number" min="0" step="1" value="0" inputmode="numeric" />
            <label style="margin-top:10px">Interest Outstanding (₹)</label>
            <input id="odToday" type="number" min="0" step="1" value="0" inputmode="numeric" />
            <label id="labelRate" style="margin-top:10px">Annual Interest Rate (%)</label>
            <input id="annualRate" type="number" min="0" step="0.01" value="27" inputmode="decimal" readonly />
            <label id="labelDate" style="margin-top:10px">First EMI Date (today)</label>
            <input id="firstDate" type="date" readonly />
            <div class="controls">
              <button id="recalc">Recalculate</button>
              <button id="reset" class="ghost action-ghost">Reset</button>
              <button id="download" class="ghost action-ghost">Download CSV</button>
              <button id="copy" class="ghost action-ghost">Copy Results</button>
            </div>
          </div>

          <table id="results" aria-live="polite">
            <thead>
              <tr>
                <th>Outstanding (₹)</th>
                <th>Offer</th>
                <th>Installment (₹)</th>
                <th>Total Collection (₹)</th>
                <th>Discount (₹)</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <p class="muted" style="margin-top:10px">Formula preview: Outstanding = Principal + InterestOutstanding + (Principal × MonthlyRate × N). Installment = Total ÷ (N+1), rounded UP to next ₹10.</p>
        </div>
      </div>

      <aside>
        <div class="card aside-list">
          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">3+1</span></div>
              <div class="small" id="meta31"></div>
            </div>
            <div class="schedule" id="sched31"></div>
          </div>

          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">4+1</span></div>
              <div class="small" id="meta41"></div>
            </div>
            <div class="schedule" id="sched41"></div>
          </div>

          <div class="offer-card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="pill">6+1</span></div>
              <div class="small" id="meta61"></div>
            </div>
            <div class="schedule" id="sched61"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer class="muted">Note: Installment is rounded <strong>up</strong> to the nearest ₹10.</footer>
  </div>

<script>
/* =========== helpers (unchanged logic) =========== */
function formatINR(n){ if (isNaN(n)) return '-'; return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(Math.round(n)); }
function addMonthsKeepDay(date, months){ const d=new Date(date.valueOf()); const day=d.getDate(); d.setMonth(d.getMonth()+months); if(d.getDate()!==day) d.setDate(0); return d; }
function roundUp10(x){ return Math.ceil(x/10)*10; }
function calcForN(principal, odToday, monthlyRate, N){
  const monthlyInterestOnPrincipal = principal * monthlyRate;
  const futureOD = monthlyInterestOnPrincipal * N;
  const total = principal + odToday + futureOD;
  const rawInstallment = total / (N + 1);
  const installment = roundUp10(rawInstallment);
  const totalCollection = installment * N;
  const discount = installment;
  return { monthlyInterestOnPrincipal, futureOD, total, rawInstallment, installment, totalCollection, discount };
}

/* =========== elements =========== */
const elPrincipal = document.getElementById('principal');
const elOD = document.getElementById('odToday');
const elRate = document.getElementById('annualRate');
const elDate = document.getElementById('firstDate');
const tbody = document.getElementById('tbody');
const meta31 = document.getElementById('meta31'), meta41 = document.getElementById('meta41'), meta61 = document.getElementById('meta61');
const sched31 = document.getElementById('sched31'), sched41 = document.getElementById('sched41'), sched61 = document.getElementById('sched61');

/* =========== ROBUST system-date watcher =========== */
/* helper to format JS Date -> YYYY-MM-DD for input value */
function toLocalDateYYYYMMDD(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

/* set hidden input from system date */
function setDateToTodayFromSystem(){
  try {
    elDate.value = toLocalDateYYYYMMDD(new Date());
  } catch(e){
    console.error('setDateToTodayFromSystem error', e);
  }
}

/* initialize and start periodic check (poll interval in ms) */
(function startDateWatcher(){
  // immediate set
  setDateToTodayFromSystem();
  // store lastKnownDate for change detection
  window._lastKnownSystemDate = elDate.value;
  // small interval for responsiveness during tests; change to 30_000 or 60_000 in production if desired
  const POLL_MS = 5000; // 5 seconds
  // clear existing if reloaded to avoid duplicates
  if (window._dateWatcherIntervalId) {
    clearInterval(window._dateWatcherIntervalId);
  }
  window._dateWatcherIntervalId = setInterval(()=>{
    const sysDate = toLocalDateYYYYMMDD(new Date());
    if (sysDate !== window._lastKnownSystemDate) {
      window._lastKnownSystemDate = sysDate;
      setDateToTodayFromSystem();
      // re-render schedules / UI
      try { renderAll(); } catch(e){ console.warn('renderAll missing', e); }
      console.info('Date watcher: system date changed -> updated to', sysDate);
    }
  }, POLL_MS);

  // also update when tab becomes visible (handles system time change while tab was hidden)
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible') {
      const sysDate = toLocalDateYYYYMMDD(new Date());
      if (sysDate !== window._lastKnownSystemDate) {
        window._lastKnownSystemDate = sysDate;
        setDateToTodayFromSystem();
        try { renderAll(); } catch(e){ }
        console.info('Date watcher: visibility change detected -> updated to', sysDate);
      }
    }
  });
})();

/* =========== rendering =========== */
function buildSchedule(dateStr, N){
  const d0 = new Date(dateStr + 'T00:00:00');
  const arr=[];
  for(let i=0;i<N;i++){
    const d = addMonthsKeepDay(d0, i);
    arr.push(d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}));
  }
  return arr;
}

function renderAll(){
  const principal = Number(elPrincipal.value) || 0;
  const odToday = Number(elOD.value) || 0;
  const annualRate = 27; // fixed
  const monthlyRate = annualRate / 12 / 100;
  const firstDate = elDate.value;
  const offers = [{label:'3+1',N:3},{label:'4+1',N:4},{label:'6+1',N:6}];
  tbody.innerHTML = '';
  offers.forEach(off=>{
    const res = calcForN(principal, odToday, monthlyRate, off.N);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="cell-amount">${formatINR(principal + odToday + res.futureOD)}</td>
                    <td>${off.label}</td>
                    <td>${formatINR(res.installment)}</td>
                    <td>${formatINR(res.totalCollection)}</td>
                    <td>${formatINR(res.discount)}</td>`;
    tbody.appendChild(tr);

    const metaTxt = `Future Interest: ${formatINR(res.futureOD)} • Monthly interest: ${formatINR(res.monthlyInterestOnPrincipal)}`;
    const sched = buildSchedule(firstDate, off.N);
    if (off.N===3){ meta31.textContent = metaTxt; sched31.innerHTML = sched.map(s=>`• ${s}`).join('<br>'); }
    if (off.N===4){ meta41.textContent = metaTxt; sched41.innerHTML = sched.map(s=>`• ${s}`).join('<br>'); }
    if (off.N===6){ meta61.textContent = metaTxt; sched61.innerHTML = sched.map(s=>`• ${s}`).join('<br>'); }
  });
}

/* =========== actions =========== */
let currentRows = [];
document.getElementById('recalc').addEventListener('click', renderAll);
document.getElementById('reset').addEventListener('click', ()=>{
  elPrincipal.value = 0; elOD.value = 0; setDateToTodayFromSystem(); renderAll();
});
document.getElementById('download').addEventListener('click', ()=>{
  const header=['Outstanding','Offer','Installment','TotalCollection','Discount'];
  const lines=[header.join(',')].concat(currentRows.map(r=>[r.Outstanding,r.Offer,r.Installment,r.TotalCollection,r.Discount].join(',')));
  const csv=lines.join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='settlement_offers.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
document.getElementById('copy').addEventListener('click', async ()=>{
  let txt=''; currentRows.forEach(r=>{ txt += `Outstanding: ${r.Outstanding}\nOffer: ${r.Offer}\nInstallment: ${r.Installment}\nTotalCollection: ${r.TotalCollection}\nDiscount: ${r.Discount}\n\n`; });
  try { await navigator.clipboard.writeText(txt); alert('Results copied to clipboard'); } catch(e){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Results copied to clipboard'); }
});

/* wire inputs */
const debounced = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
elPrincipal.addEventListener('input', debounced(renderAll,160));
elOD.addEventListener('input', debounced(renderAll,160));

/* initial render */
renderAll();
</script>
</body>
</html>
